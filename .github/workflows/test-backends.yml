name: "Build backends with an updated Colvars module"

on: [push, pull_request]


jobs:
  lammps:
    name: Test LAMMPS
    uses: Colvars/colvars/.github/workflows/backend-template.yml@test_ci
    with:
      backend_name: LAMMPS
      backend_repo: lammps/lammps
      backend_repo_ref: develop
      path_compile_script: devel-tools/compile-lammps.sh
      test_lib_directory: lammps/tests/library
      rpath_exe: install/bin/lmp

  namd:
    name: Test NAMD
    uses: Colvars/colvars/.github/workflows/backend-template.yml@test_ci
    with:
      backend_name: NAMD
      backend_repo: Colvars/namd
      backend_repo_ref: master
      path_compile_script: devel-tools/compile-namd.sh
      test_lib_directory: namd/tests/library
      test_interface_directory: namd/tests/interface
      rpath_exe: Linux-x86_64-g++.multicore/namd2
    secrets:
      # Per-repository secret (sharing a secret from the org with all
      # repositories turned out to be too complex)
      private_key: ${{ secrets.PULL_NAMD_KEY }}

  vmd:
    name: Test VMD
    uses: Colvars/colvars/.github/workflows/backend-template.yml@test_ci
    with:
      backend_name: VMD
      backend_repo: Colvars/vmd
      backend_repo_ref: master
      path_compile_script: devel-tools/compile-vmd.sh
      test_lib_directory: vmd/tests/interface
      rpath_exe: install/vmd
    secrets:
      # Per-repository secret (sharing a secret from the org with all
      # repositories turned out to be too complex)
      private_key: ${{ secrets.PULL_VMD_KEY }}



    # - name: Checkout VMD
    #   uses: actions/checkout@v2
    #   with:
    #     repository: 'Colvars/vmd'
    #     ssh-key: ${{ secrets.PULL_VMD_KEY }}
    #     ref: 'master'
    #     path: 'vmd-source'

    # - name: Checkout VMD plugins
    #   uses: actions/checkout@v2
    #   with:
    #     repository: 'Colvars/vmd-plugins'
    #     ssh-key: ${{ secrets.PULL_VMD_PLUGINS_KEY }}
    #     ref: 'master'
    #     path: 'vmd-plugins-source'



    # - name: Run regression tests for library code with NAMD
    #   shell: bash
    #   working-directory: namd/tests/library
    #   run: |
    #     singularity exec ${{github.workspace}}/devel-tools/CentOS7-devel.sif \
    #     ./run_tests.sh ${{github.workspace}}/namd-source/Linux-x86_64-g++.multicore/namd2

    # - name: Run regression tests for NAMD interface code
    #   shell: bash
    #   working-directory: namd/tests/interface
    #   run: |
    #     singularity exec ${{github.workspace}}/devel-tools/CentOS7-devel.sif \
    #     ./run_tests.sh ${{github.workspace}}/namd-source/Linux-x86_64-g++.multicore/namd2

    # - name: Update and build VMD
    #   shell: bash
    #   run: |
    #     singularity exec devel-tools/CentOS7-devel.sif ./update-colvars-code.sh vmd-source
    #     CCACHE_DIR=~/ccache_CentOS7-devel \
    #     singularity exec devel-tools/CentOS7-devel.sif \
    #     bash devel-tools/compile-vmd.sh vmd-source

    # - name: Run regression tests for VMD interface code
    #   shell: bash
    #   working-directory: vmd/tests/interface
    #   run: |
    #     singularity exec ${{github.workspace}}/devel-tools/CentOS7-devel.sif \
    #     ./run_tests.sh ${{github.workspace}}/vmd-source/install/vmd
